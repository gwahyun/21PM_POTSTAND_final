<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="function">

	<resultMap type="notice" id="noticeMap">
		<id column="NOTICE_NO" property="noticeNo"/>
		<result column="MEMBER_ID" property="memberId"/>
		<result column="NOTICE_CONTENT" property="noticeContent"/>
		<result column="NOTICE_DATE" property="noticeDate"/>
		<result column="NOTICE_TITLE" property="noticeTitle"/>
		<result column="NOTICE_VIEW" property="noticeView"/>		
	</resultMap>
	
	<resultMap type="qna" id="qnaMap">
		<id column="QNA_NO" property="qnaNo"/>
		<result column="MEMBER_ID" property="memberId"/>
		<result column="QNA_CONTENT" property="qnaContent"/>
		<result column="QNA_DATE" property="qnaDate"/>
		<result column="QNA_TITLE" property="qnaTitle"/>
		<result column="QNA_STATUS" property="qnaStatus"/>
		<result column="QNA_SORT" property="qnaSort"/>
		<association property="answer" resultMap="answerJoin"/>		
	</resultMap>
	
	<resultMap type="answer" id="answerJoin">
		<id column="ANSWER_NO" property="answerNo"/>
		<result column="QNA_NO" property="qnaNo"/>
		<result column="ADMIN_ID" property="adminId"/>
		<result column="ANSWER_CONTENT" property="answerContent"/>
		<result column="ANSWER_DATE" property="answerDate"/>		
	</resultMap>
	
	<resultMap type="sort" id="sortMap">
		<id column="SORT_NO" property="sortNo"/>
		<result column="LV1" property="lv1"/>
		<result column="LV2" property="lv2"/>
		<result column="LV3" property="lv3"/>
		<result column="LV4" property="lv4"/>		
	</resultMap>
	<select id="selectSortByPK" resultMap="sortMap">
		SELECT * FROM SORT WHERE SORT_NO=#{sortNo}
	</select>
	
	<resultMap type="book" id="bookMap">
		<id column="BOOK_CODE" property="bookCode"/>
		<result column="BOOK_TITLE" property="bookTitle"/>
		<result column="BOOK_WRITER" property="bookWriter"/>
		<result column="BOOK_PUB" property="bookPub"/>
		<result column="BOOK_COST" property="bookCost"/>
		<result column="BOOK_SHORT" property="bookShort"/>
		<result column="BOOK_COVER" property="bookCover"/>
		<result column="BOOK_DATE" property="bookDate"/>
		<result column="BOOK_LINK" property="bookLink"/>
		<result column="BOOK_INTRO" property="bookIntro"/>
		<result column="WRITER_INTRO" property="writerIntro"/>
		<result column="BOOK_INDEX" property="bookIndex"/>
		<result column="PUB_REVIEW" property="pubReview"/>
		<result column="BOOK_EXTRACT" property="bookExtract"/>
		<result column="RECOMMAND" property="recommand"/>
		<result column="INTRO_MV" property="introMv"/>
		<association column="SORT_NO" property="sort" select="selectSortByPK"/>
	</resultMap>
	<select id="selectBookByPK" resultMap="bookMap">
		SELECT * FROM BOOK WHERE BOOK_CODE=#{bookCode}
	</select>
	
	<!-- 쿠폰 리절트맵 + selectByPK -->
	<resultMap type="coupon" id="couponMap">
		<id column="COUPON_NO" property="couponNo"/>
		<result column="MEMBER_ID" property="memberId"/>
		<result column="START_DATE" property="startDate"/>
		<result column="VAL_DATE" property="valDate"/>
		<result column="USED_DATE" property="usedDate"/>
		<result column="COUPON_END" property="couponEnd"/>
		<result column="COUPON_AMOUNT" property="couponAmount"/>
		<association column="EVENT_NO" property="event" select="selectEventByPK"/>
	</resultMap>
	
	
	<resultMap type="cart" id="cartMap">
		<id column="CART_NO" property="cartNo"/>
		<result column="MEMBER_ID" property="memberId"/>
		<result column="BOOK_AMOUNT" property="bookAmount"/>
		<result column="USED_COUPON_NO" property="usedCouponNo"/>
		<association property="book" resultMap="bookMap"/>	
		<collection property="coupon" resultMap="couponMap"/>
	</resultMap>
	
	
	
	
	<resultMap type="event" id="eventMap">
		<id column="event_no" property="eventNo"/>
		<result column="event_title" property="eventTitle"/>
		<result column="event_info" property="eventInfo" typeHandler="longHandler"/>
		<result column="event_short" property="eventShort"/>
		<result column="event_start" property="eventStart"/>
		<result column="event_end" property="eventEnd"/>
		<result column="end_check" property="endCheck"/>
		<result column="event_thum" property="eventThum"/>
		<result column="TYPE" property="type"/>
		<result column="DISCOUNT" property="discount"/>
	</resultMap>

	<select id="selectEventByPK" resultMap="eventMap">
		select * from event where event_no = #{eventNo}
	</select>
	
	
	<select id="noticeSelectList" resultMap="noticeMap">
		SELECT * FROM NOTICE ORDER BY NOTICE_DATE DESC
	</select>
	
	<select id="noticeSelectOne" resultMap="noticeMap">
		SELECT * FROM NOTICE WHERE NOTICE_NO=#{noticeNo}
	</select>
	
	<select id="noticeSelectCount" resultType="_int">
		SELECT COUNT(*) FROM NOTICE
	</select>
	
	<select id="qnaSelectList" resultMap="qnaMap">
		SELECT * FROM QNA WHERE MEMBER_ID=#{memberId} ORDER BY QNA_DATE DESC
	</select>
	
	<select id="qnaSelectOne" resultMap="qnaMap">
		SELECT * FROM QNA LEFT JOIN ANSWER USING (QNA_NO) WHERE QNA_NO=#{qnaNo}
	</select>
	
	<select id="qnaSelectCount" resultType="_int">
		SELECT COUNT(*) FROM QNA WHERE MEMBER_ID=#{memberId}
	</select>
	
	<select id="cartSelectListJoinEventList" resultMap="cartMap">
		SELECT * FROM CART_BOOK_COUPON WHERE MEMBER_ID=#{memberId} AND (COUPON_END IS NULL OR COUPON_END='N')
	</select>
	
	<insert id="qnaInsert">
		 INSERT INTO QNA VALUES(SEQ_QNA.NEXTVAL, #{memberId}, #{qnaSort}, #{qnaTitle}, #{qnaContent}, DEFAULT, DEFAULT)
	</insert>
	
	<delete id="cartObjDelete">
		DELETE FROM CART
		<where>
			<if test="memberId!=null and memberId!=''">
				MEMBER_ID=#{memberId}
			</if>
			<if test="cartNo!=null and cartNo!=''">
				CART_NO=#{cartNo}
			</if>
		</where>
	</delete>
	
	<!-- 임시기능 나중에 삭제 -->
	<insert id="insertSort">
		INSERT INTO SORT VALUES(#{sortNo}, #{lv1}, #{lv2}, #{lv3}, #{lv4})
	</insert>
		<update id="cartBookAmountUpdate">
		UPDATE CART SET BOOK_AMOUNT=#{bookAmount} WHERE CART_NO=#{cartNo}
	</update>
	<update id="cartCouponUpdate">
		<if test="usedCouponNo!=null">
			UPDATE CART SET USED_COUPON_NO=#{usedCouponNo} WHERE CART_NO=#{cartNo}
		</if>
		<if test="usedCouponNo==null">
			UPDATE CART SET USED_COUPON_NO=NULL WHERE CART_NO=#{cartNo}
		</if>
	</update>
	
	<select id="selectSortAll" resultMap="sortMap">
		select * from sort
	</select>
	<insert id="insertBook" parameterType="book">
		insert into book values(seq_book.nextval, #{sort.sortNo}, #{bookTitle}, #{bookWriter}, #{bookPub}, #{bookCost}, null , #{bookCover}, #{bookDate}, null, #{bookLink}, null, null, null, null, null, null, null)
	</insert>
</mapper>
